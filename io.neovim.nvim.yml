app-id:              io.neovim.nvim

runtime:             org.freedesktop.Platform
runtime-version:     '18.08'

sdk:                 org.freedesktop.Sdk

command:             nvim
rename-desktop-file: nvim.desktop
rename-icon:         nvim

finish-args:
  # Edit anything
  - --filesystem=host
  # Plugin updates
  - --share=network


modules:
  - name: libuv
    sources:
      - type: archive
        url: https://github.com/libuv/libuv/archive/v1.12.0.tar.gz
        sha256: 41ce914a88da21d3b07a76023beca57576ca5b376c6ac440c80bc581cbca1250
    cleanup:
      - /include
      - /lib/pkgconfig
      - "*.a"
      - "*.la"


  - name: msgpack-c
    buildsystem: cmake-ninja
    sources:
      - type: archive
        url: https://github.com/msgpack/msgpack-c/releases/download/cpp-3.0.0/msgpack-3.0.0.tar.gz
        sha256: bfbb71b7c02f806393bc3cbc491b40523b89e64f83860c58e3e54af47de176e4
    cleanup:
      - /include
      - /lib/cmake
      - /lib/pkgconfig
      - "*.a"


  - name: LuaJIT
    no-autogen: true
    make-install-args:
      - PREFIX=/app
    sources:
      - type: archive
        url: https://github.com/LuaJIT/LuaJIT/archive/7dbf0b05f1228c1c719866db5e5f3d58f87f74c8.tar.gz
        sha256: cbae019b5e396164eb5f0d07777b55cc03931bb944f83c61a010c053c9f5fd5b
      - type: shell
        commands:
          - sed -i "s|/usr/local|/app|" ./src/luaconf.h
    cleanup:
      - /bin
      - /include
      - /lib/pkgconfig
      - /share/man
      - "*.a"


  - name: lpeg
    no-autogen: true
    no-make-install: true
    make-args:
      - LUADIR=/app/include/luajit-2.0/
    post-install:
      - install -Dm755 -t /app/lib/lua/5.1/ lpeg.so
      - install -Dm644 -t /app/share/lua/5.1/ re.lua
    sources:
      - type: archive
        url: http://www.inf.puc-rio.br/~roberto/lpeg/lpeg-1.0.1.tar.gz
        sha256: 62d9f7a9ea3c1f215c77e0cadd8534c6ad9af0fb711c3f89188a8891c72f026b


  - name: mpack-lua
    no-autogen: true
    make-args:
      - USE_SYSTEM_MPACK=yes
      - LUA_INCLUDE=-I/app/include/luajit-2.0/
    make-install-args:
      - USE_SYSTEM_MPACK=yes
    sources:
      - type: archive
        url: https://github.com/libmpack/libmpack-lua/archive/1.0.7.tar.gz
        sha256: 2ebe9c8972c378040c9b8505f5fb40a0c64d990cd68be6a62989362b18294d0a
      - type: shell
        commands:
          - sed -i "s|/usr/lib|/app/lib|" ./Makefile
    modules:
      - name: mpack
        no-autogen: true
        make-install-args:
          - PREFIX=/app
        sources:
          - type: archive
            url: https://github.com/libmpack/libmpack/archive/1.0.5.tar.gz
            sha256: 4ce91395d81ccea97d3ad4cb962f8540d166e59d3e2ddce8a22979b49f108956
        cleanup:
          - /include
          - /lib/pkgconfig
          - "*.la"


  - name: libvterm
    no-autogen: true
    make-install-args:
      - PREFIX=/app
    sources:
      - type: archive
        url: https://github.com/neovim/libvterm/archive/a9c7c6fd20fa35e0ad3e0e98901ca12dfca9c25c.tar.gz
        sha256: 1a4272be91d9614dc183a503786df83b6584e4afaab7feaaa5409f841afbd796
    cleanup:
      - /bin
      - /include
      - /lib/pkgconfig
      - "*.a"
      - "*.la"


  - name: jemalloc
    sources:
      - type: archive
        url: https://github.com/jemalloc/jemalloc/releases/download/4.5.0/jemalloc-4.5.0.tar.bz2
        sha256: 9409d85664b4f135b77518b0b118c549009dc10f6cba14557d170476611f6780
    cleanup:
      - /bin
      - /include
      - /lib/pkgconfig
      - /share/man
      - /share/doc
      - "*.a"


  - name: unibilium
    no-autogen: true
    make-install-args:
      - PREFIX=/app
    sources:
      - type: archive
        url: https://github.com/mauke/unibilium/archive/v2.0.0.tar.gz
        sha256: 78997d38d4c8177c60d3d0c1aa8c53fd0806eb21825b7b335b1768d7116bc1c1
    cleanup:
      - /include
      - /lib/pkgconfig
      - /share/man
      - "*.la"


  - name: libtermkey
    no-autogen: true
    make-install-args:
      - PREFIX=/app
    sources:
      - type: archive
        url: http://www.leonerd.org.uk/code/libtermkey/libtermkey-0.20.tar.gz
        sha256: 6c0d87c94ab9915e76ecd313baec08dedf3bd56de83743d9aa923a081935d2f5
    cleanup:
      - /include
      - /lib/pkgconfig
      - /share/man
      - "*.la"


  - name: neovim
    buildsystem: cmake-ninja
    builddir: true
    config-opts:
      - -DCMAKE_BUILD_TYPE=RelWithDebInfo
    post-install:
      - mkdir -p /app/share/icons/hicolor/128x128/apps
      - mv /app/share/pixmaps/* /app/share/icons/hicolor/128x128/apps/
    sources:
      - type: archive
        url: https://github.com/neovim/neovim/archive/v0.3.1.tar.gz
        sha256: bc5e392d4c076407906ccecbc283e1a44b7832c2f486cad81aa04cc29973ad22
